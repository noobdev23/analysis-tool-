<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Market Insight — Stocks & Crypto Analysis Tool</title>
<meta name="description" content="Combined stock fundamental & technical analysis and crypto analysis tool. Charts, indicators, CSV import/export, CoinGecko live crypto prices, optional Alpha Vantage for stocks." />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%2301262b'/%3E%3Ctext x='50' y='58' text-anchor='middle' font-size='40' fill='%23ffd24d' font-family='Arial'%3E$%3C/text%3E%3C/svg%3E">
<style>
  :root{--bg:#061622;--card:#071725;--accent:#ffd24d;--muted:#9fb4c8;--text:#eaf6ff}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;color:var(--text);background:linear-gradient(180deg,#041219,#071624)}
  .wrap{max-width:1100px;margin:18px auto;padding:18px}
  header{display:flex;align-items:center;gap:12px}
  header h1{margin:0;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  label{display:block;margin-top:10px;color:var(--muted);font-size:14px}
  input,select,button,textarea{font-size:15px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
  button{background:var(--accent);color:#05233a;cursor:pointer;border:none;font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{color:var(--accent)}
  .chart{height:320px;margin-top:12px;padding:8px;border-radius:8px;background:linear-gradient(180deg,#021216,#021218)}
  footer{grid-column:1/-1;margin-top:12px;color:var(--muted);font-size:13px}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .small{font-size:13px;color:var(--muted)}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <svg width="44" height="44" viewBox="0 0 24 24" aria-hidden="true"><rect width="24" height="24" rx="4" fill="#ffd24d"></rect><path d="M4 16h2v-6H4zM9 16h2V8H9zM14 16h2v-10h-2z" fill="#05233a"/></svg>
      <div>
        <h1>Market Insight — Stocks & Crypto</h1>
        <div class="muted">Fundamental + technical analysis, crypto live data, charting, CSV import/export. Optional API keys for live stock quotes.</div>
      </div>
    </header>

    <nav aria-label="Quick actions">
      <button id="gotoStock">Stocks</button>
      <button id="gotoCrypto">Crypto</button>
      <button id="gotoAbout">About</button>
      <button id="gotoContact">Contact Us</button>
    </nav>

    <div class="grid">
      <main class="card" id="main">
        <section id="stockSection">
          <h2>Stock Analysis</h2>
          <p class="muted">Enter a ticker and choose source. For live stock prices, provide an Alpha Vantage API key in Settings (aside) — otherwise you can paste CSV price data or use simulated data.</p>

          <label for="stockSymbol">Ticker / Symbol (e.g., AAPL)</label>
          <input id="stockSymbol" placeholder="AAPL" value="AAPL">

          <label for="stockSource">Price Source</label>
          <select id="stockSource">
            <option value="sim">Simulated (no API key)</option>
            <option value="alphavantage">Alpha Vantage (requires API key)</option>
            <option value="csv">Upload CSV (date,open,high,low,close,volume)</option>
          </select>

          <div class="actions">
            <button id="fetchStock">Fetch / Load</button>
            <button id="stockSMA">SMA</button>
            <button id="stockEMA">EMA</button>
            <button id="stockRSI">RSI</button>
            <button id="stockMACD">MACD</button>
            <button id="downloadStockCsv">Download CSV</button>
          </div>

          <div id="stockMeta" class="small" style="margin-top:10px"></div>

          <div id="stockChart" class="chart" role="img" aria-label="Stock price chart"></div>

          <h3 style="margin-top:12px">Fundamentals (manual / pasted)</h3>
          <div class="muted">Paste or input company fundamentals — the tool provides ratio calculations (P/E, P/B, Dividend yield) from your input.</div>
          <label for="fundCsv">Paste fundamentals (JSON or CSV)</label>
          <textarea id="fundCsv" rows="4" placeholder='{"marketCap":1000000000,"eps":5,"bookValue":50,"dividend":1}'></textarea>
          <div class="actions"><button id="parseFund">Parse Fundamentals</button></div>
          <div id="fundOutput" class="small" style="margin-top:8px"></div>
        </section>

        <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

        <section id="cryptoSection" style="display:none">
          <h2>Crypto Analysis</h2>
          <p class="muted">Live crypto prices are fetched from CoinGecko (no API key required). Enter symbol (e.g., bitcoin or bitcoin/market vs vs usd) or pick from popular coins.</p>
          <label for="cryptoSelect">Coin ID (CoinGecko):</label>
          <input id="cryptoSelect" placeholder="bitcoin" value="bitcoin">
          <div class="actions">
            <button id="fetchCrypto">Fetch Crypto</button>
            <button id="cryptoSMA">SMA</button>
            <button id="cryptoRSI">RSI</button>
            <button id="cryptoMACD">MACD</button>
            <button id="downloadCryptoCsv">Download CSV</button>
          </div>
          <div id="cryptoMeta" class="small" style="margin-top:10px"></div>
          <div id="cryptoChart" class="chart" role="img" aria-label="Crypto price chart"></div>
        </section>

        <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

        <section id="dataSection">
          <h3>Data Import / Export</h3>
          <label for="fileInput">Upload CSV for prices (date,open,high,low,close,volume)</label>
          <input id="fileInput" type="file" accept=".csv,text/csv">
          <div class="muted" style="margin-top:8px">You can paste CSV into the stock source option or upload here to feed analyses.</div>
        </section>

      </main>

      <aside class="card" id="aside">
        <h3>Settings & Utilities</h3>
        <label for="alphaKey">Alpha Vantage API Key (stock prices)</label>
        <input id="alphaKey" placeholder="Optional: Alpha Vantage key">
        <label for="currency">Display currency</label>
        <select id="currency"><option value="USD">USD</option><option value="INR">INR</option></select>
        <label for="smoothing">Default SMA/EMA length</label>
        <input id="smoothing" type="number" min="5" max="200" value="14">
        <div class="actions" style="margin-top:10px">
          <button id="clearData">Clear Data</button>
          <button id="voiceBtn">Voice: Off</button>
        </div>

        <hr style="margin-top:12px;border:none;border-top:1px solid rgba(255,255,255,0.04)">

        <h4>About</h4>
        <p class="small">Market Insight is a browser-only tool that helps creators and traders quickly analyze stocks and crypto. For production usage add server-side APIs and proper rate-limiting.</p>

        <h4>Contact</h4>
        <p class="small">Email: <a href="mailto:hello@example.com">hello@example.com</a></p>
        <p class="small">GitHub: <a href="#" id="ghLink">your-github</a></p>
      </aside>
    </div>

    <footer>
      <div class="muted">This tool is for research and learning only — not financial advice. For live trading and production data pipelines, use secure server-side APIs and follow compliance.</div>
    </footer>
  </div>

<script>
// Market Insight — combined stocks & crypto analysis tool (single-file)

// Utility helpers
function el(id){ return document.getElementById(id); }
function csvToRows(txt){
  return txt.split(/\r?\n/).map(r=>r.trim()).filter(Boolean).map(r=>{
    // naive split by comma, handle quoted values
    const cols = [];
    let cur = '', inQuotes=false;
    for(let i=0;i<r.length;i++){
      const ch = r[i];
      if(ch === '"'){ inQuotes = !inQuotes; continue;}
      if(ch === ',' && !inQuotes){ cols.push(cur); cur=''; continue;}
      cur += ch;
    }
    cols.push(cur);
    return cols.map(c=>c.trim());
  });
}

// Simple charting using lightweight SVG (no external libs)
function renderLineChart(container, series, opts={}){
  container.innerHTML = '';
  const svgNS = 'http://www.w3.org/2000/svg';
  const w = container.clientWidth || 800;
  const h = container.clientHeight || 320;
  const svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  svg.setAttribute('width','100%');
  svg.setAttribute('height',h);
  // background
  const rect = document.createElementNS(svgNS,'rect'); rect.setAttribute('x',0); rect.setAttribute('y',0); rect.setAttribute('width',w); rect.setAttribute('height',h); rect.setAttribute('fill','#021216'); svg.appendChild(rect);
  if(!series || series.length === 0){
    const txt = document.createElementNS(svgNS,'text'); txt.setAttribute('x',w/2); txt.setAttribute('y',h/2); txt.setAttribute('fill','#88b4c9'); txt.setAttribute('text-anchor','middle'); txt.textContent = 'No data'; svg.appendChild(txt); container.appendChild(svg); return;
  }
  const values = series.map(s=>s.value);
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = (max - min) || 1;
  const stepX = (w - 60) / Math.max(1, series.length - 1);
  // path
  let d = '';
  series.forEach((pt,i)=>{
    const x = 40 + i*stepX;
    const y = h - 30 - ((pt.value - min)/range)*(h - 80);
    d += (i===0? 'M':'L') + x + ' ' + y + ' ';
    // label for last point
    if(i === series.length-1){
      const circle = document.createElementNS(svgNS,'circle'); circle.setAttribute('cx',x); circle.setAttribute('cy',y); circle.setAttribute('r',4); circle.setAttribute('fill','#ffd24d'); svg.appendChild(circle);
      const lbl = document.createElementNS(svgNS,'text'); lbl.setAttribute('x', x+8); lbl.setAttribute('y', y-8); lbl.setAttribute('fill','#eaf6ff'); lbl.setAttribute('font-size','12'); lbl.textContent = (pt.label || '') + ' ' + pt.value.toFixed(2); svg.appendChild(lbl);
    }
  });
  const path = document.createElementNS(svgNS,'path'); path.setAttribute('d', d.trim()); path.setAttribute('stroke','#00c2a8'); path.setAttribute('stroke-width','2'); path.setAttribute('fill','none'); svg.appendChild(path);
  container.appendChild(svg);
}

// Indicators (simple implementations)
function sma(values, len){
  const out = [];
  for(let i=0;i<values.length;i++){
    if(i < len-1){ out.push(null); continue; }
    let s = 0;
    for(let j=0;j<len;j++) s += values[i-j];
    out.push(s/len);
  }
  return out;
}
function ema(values, len){
  const out = [];
  const k = 2/(len+1);
  let prev = values[0];
  out[0] = prev;
  for(let i=1;i<values.length;i++){
    const v = values[i];
    const e = v * k + prev * (1-k);
    out.push(e);
    prev = e;
  }
  return out;
}
function rsi(values, period=14){
  const gains = [], losses = [];
  for(let i=1;i<values.length;i++){
    const diff = values[i] - values[i-1];
    gains.push(Math.max(0,diff));
    losses.push(Math.max(0,-diff));
  }
  let avgGain = gains.slice(0,period).reduce((a,b)=>a+b,0)/period;
  let avgLoss = losses.slice(0,period).reduce((a,b)=>a+b,0)/period;
  const out = Array(values.length).fill(null);
  out[period] = 100 - (100/(1 + (avgGain/avgLoss || 0)));
  for(let i=period+1;i<values.length;i++){
    avgGain = (avgGain * (period-1) + gains[i-1]) / period;
    avgLoss = (avgLoss * (period-1) + losses[i-1]) / period;
    const rs = avgGain / (avgLoss || 1e-9);
    out[i] = 100 - (100/(1+rs));
  }
  return out;
}
// MACD: ema12 - ema26
function macd(values, short=12,long=26,signal=9){
  const eShort = ema(values, short);
  const eLong = ema(values, long);
  const macdLine = values.map((v,i)=> (eShort[i] || 0) - (eLong[i] || 0));
  const signalLine = ema(macdLine, signal);
  return {macd: macdLine, signal: signalLine};
}

// State
let priceData = []; // array of {date,open,high,low,close,volume}
let currentSymbol = '';
let currentMarket = 'stock'; // or 'crypto'

// Helpers to parse CSV with header
function parsePriceCsv(txt){
  const rows = csvToRows(txt);
  const hdr = rows[0].map(h=>h.toLowerCase());
  const out = [];
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    const obj = {};
    for(let j=0;j<hdr.length;j++) obj[hdr[j]] = r[j] || '';
    // expected fields: date,open,high,low,close,volume
    out.push({
      date: obj.date || obj.timestamp || obj.time,
      open: parseFloat(obj.open||obj.o||obj[1]||0),
      high: parseFloat(obj.high||obj.h||0),
      low: parseFloat(obj.low||obj.l||0),
      close: parseFloat(obj.close||obj.c||0),
      volume: parseFloat(obj.volume||obj.v||0)
    });
  }
  return out;
}

// Simulated price generator (walk) for demo
function simulatePrices(symbol, points=120, start=100){
  const out = [];
  let price = start;
  for(let i=points-1;i>=0;i--){
    const t = new Date(Date.now() - i*60*60*1000);
    const change = (Math.random()-0.5) * 2; // +/- 1
    price = Math.max(0.01, price + change);
    out.push({date: t.toISOString(), open: price-change, high: price + Math.abs(change)*0.6, low: price - Math.abs(change)*0.6, close: price, volume: Math.round(1000 + Math.random()*500)});
  }
  return out;
}

// Fetch crypto from CoinGecko (market chart)
async function fetchCryptoHistory(coinId, days=30, vs_currency='usd'){
  try{
    const url = `https://api.coingecko.com/api/v3/coins/${encodeURIComponent(coinId)}/market_chart?vs_currency=${vs_currency}&days=${days}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('CoinGecko fetch failed: ' + res.status);
    const j = await res.json();
    // j.prices is [ [ts, price], ... ] ; volumes in total_volumes ; transform to OHLC-like
    const prices = j.prices;
    const volumes = j.total_volumes || [];
    const out = prices.map((p,i)=>{
      const dt = new Date(p[0]).toISOString();
      const close = p[1];
      const open = (i>0 ? prices[i-1][1] : close);
      const high = Math.max(open, close);
      const low = Math.min(open, close);
      const volume = volumes[i] ? volumes[i][1] : 0;
      return {date: dt, open, high, low, close, volume};
    });
    return out;
  }catch(e){
    alert('CoinGecko error: ' + e.message);
    return [];
  }
}

// Fetch stocks using Alpha Vantage (if key provided)
async function fetchStockAlpha(symbol){
  const key = el('alphaKey').value.trim();
  if(!key){ alert('Alpha Vantage key required for live stock data. Set it in Settings.'); return []; }
  const func = 'TIME_SERIES_DAILY_ADJUSTED';
  const url = `https://www.alphavantage.co/query?function=${func}&symbol=${encodeURIComponent(symbol)}&outputsize=compact&apikey=${encodeURIComponent(key)}`;
  const res = await fetch(url);
  const j = await res.json();
  if(j['Error Message'] || !j['Time Series (Daily)']){ alert('Alpha Vantage error or limit reached.'); return []; }
  const series = j['Time Series (Daily)'];
  const out = Object.keys(series).map(dt=>{
    const row = series[dt];
    return {date: new Date(dt).toISOString(), open: parseFloat(row['1. open']), high: parseFloat(row['2. high']), low: parseFloat(row['3. low']), close: parseFloat(row['4. close']), volume: parseFloat(row['6. volume']||0)};
  }).sort((a,b)=> new Date(a.date) - new Date(b.date));
  return out;
}

// UI actions
el('gotoStock').addEventListener('click', ()=> { el('stockSection').style.display='block'; el('cryptoSection').style.display='none'; });
el('gotoCrypto').addEventListener('click', ()=> { el('stockSection').style.display='none'; el('cryptoSection').style.display='block'; });
el('gotoAbout').addEventListener('click', ()=> { window.scrollTo({top: document.body.scrollHeight - 200, behavior:'smooth'}); });
el('gotoContact').addEventListener('click', ()=> { window.location.hash = '#contact'; });

// File upload for generic prices
el('fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  priceData = parsePriceCsv(txt);
  currentMarket = 'stock';
  currentSymbol = 'uploaded';
  renderChartForPriceData();
  el('stockMeta').textContent = `Loaded ${priceData.length} rows from file.`;
});

// Download CSV buttons
el('downloadStockCsv').addEventListener('click', ()=> {
  if(!priceData || priceData.length===0){ alert('No price data'); return; }
  const rows = [['date','open','high','low','close','volume']];
  priceData.forEach(r=> rows.push([r.date,r.open,r.high,r.low,r.close,r.volume]));
  const blob = new Blob([rows.map(r=>r.join(',')).join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = (currentSymbol||'data') + '_prices.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// Stock fetch / load
el('fetchStock').addEventListener('click', async ()=>{
  const sym = el('stockSymbol').value.trim().toUpperCase();
  if(!sym){ alert('Enter symbol'); return; }
  currentSymbol = sym;
  const source = el('stockSource').value;
  if(source === 'sim'){
    priceData = simulatePrices(sym, 180, 100 + Math.random()*50);
    el('stockMeta').textContent = 'Simulated data loaded.';
    renderChartForPriceData();
  } else if(source === 'alphavantage'){
    const fetched = await fetchStockAlpha(sym);
    if(fetched.length) { priceData = fetched; el('stockMeta').textContent = 'Alpha Vantage data loaded.'; renderChartForPriceData(); }
  } else {
    // csv option: prompt user to paste CSV into textarea
    const txt = prompt('Paste CSV text (date,open,high,low,close,volume) — first line header');
    if(txt){ priceData = parsePriceCsv(txt); el('stockMeta').textContent = `Loaded ${priceData.length} rows from pasted CSV`; renderChartForPriceData(); }
  }
});

// Crypto fetch
el('fetchCrypto').addEventListener('click', async ()=>{
  const id = el('cryptoSelect').value.trim();
  if(!id){ alert('Enter CoinGecko coin id like bitcoin'); return; }
  currentSymbol = id;
  priceData = await fetchCryptoHistory(id, 60, el('currency').value.toLowerCase());
  el('cryptoMeta').textContent = priceData.length ? `Loaded ${priceData.length} points from CoinGecko.` : 'No data';
  renderChartForPriceData();
});

// Indicator buttons
el('stockSMA').addEventListener('click', ()=> applyIndicator('sma'));
el('stockEMA').addEventListener('click', ()=> applyIndicator('ema'));
el('stockRSI').addEventListener('click', ()=> applyIndicator('rsi'));
el('stockMACD').addEventListener('click', ()=> applyIndicator('macd'));
el('cryptoSMA').addEventListener('click', ()=> applyIndicator('sma'));
el('cryptoRSI').addEventListener('click', ()=> applyIndicator('rsi'));
el('cryptoMACD').addEventListener('click', ()=> applyIndicator('macd'));
el('downloadCryptoCsv').addEventListener('click', ()=> el('downloadStockCsv').click());

// apply indicator and re-render
function applyIndicator(ind){
  if(!priceData || priceData.length===0){ alert('Load price data first'); return; }
  const closes = priceData.map(r=>r.close);
  const len = parseInt(el('smoothing').value) || 14;
  if(ind === 'sma'){
    const s = sma(closes, len);
    const series = priceData.map((r,i)=> ({date:r.date, value: s[i] || r.close, label: ''}));
    renderLineChart(el('stockChart'), series);
    el('stockMeta').textContent = `SMA(${len}) applied.`;
  } else if(ind === 'ema'){
    const s = ema(closes, len);
    const series = priceData.map((r,i)=> ({date:r.date, value: s[i] || r.close, label: ''}));
    renderLineChart(el('stockChart'), series);
    el('stockMeta').textContent = `EMA(${len}) applied.`;
  } else if(ind === 'rsi'){
    const s = rsi(closes, len);
    const series = priceData.map((r,i)=> ({date:r.date, value: s[i] || 0, label: ''}));
    renderLineChart(el('stockChart'), series);
    el('stockMeta').textContent = `RSI(${len}) applied.`;
  } else if(ind === 'macd'){
    const res = macd(closes);
    const series = priceData.map((r,i)=> ({date:r.date, value: res.macd[i] || 0, label: ''}));
    renderLineChart(el('stockChart'), series);
    el('stockMeta').textContent = `MACD applied (macd line shown).`;
  }
}

// render price chart default (close)
function renderChartForPriceData(){
  if(!priceData || priceData.length===0) { el('stockChart').innerHTML = ''; return; }
  const series = priceData.map(r=> ({date:r.date, value: r.close, label: ''}));
  renderLineChart(el('stockChart'), series);
  // also for crypto chart element if visible
  if(el('cryptoSection').style.display !== 'none'){
    renderLineChart(el('cryptoChart'), series);
  }
}

// fundamentals parse
el('parseFund').addEventListener('click', ()=>{
  const txt = el('fundCsv').value.trim();
  if(!txt){ alert('Paste fundamentals JSON or CSV'); return; }
  try{
    let obj;
    if(txt.startsWith('{')) obj = JSON.parse(txt);
    else {
      // CSV key,value per line
      obj = {};
      const rows = txt.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
      rows.forEach(r=>{
        const [k,v] = r.split(',').map(s=>s.trim());
        if(k) obj[k]=parseFloat(v)||v;
      });
    }
    const price = priceData.length ? priceData[priceData.length-1].close : null;
    const eps = obj.eps || obj.EPS;
    const bv = obj.bookValue || obj.book || obj.bv;
    const div = obj.dividend || obj.div || 0;
    const pe = price && eps ? (price/eps).toFixed(2) : '—';
    const pb = price && bv ? (price/bv).toFixed(2) : '—';
    const divYield = price ? ((div/price)*100).toFixed(2) + '%' : '—';
    el('fundOutput').textContent = `P/E: ${pe} • P/B: ${pb} • Dividend yield: ${divYield}`;
  }catch(e){
    alert('Parse error: ' + e.message);
  }
});

// voice toggle (simple)
let voiceOn = false;
el('voiceBtn').addEventListener('click', ()=> {
  voiceOn = !voiceOn;
  el('voiceBtn').textContent = 'Voice: ' + (voiceOn? 'On':'Off');
  if(voiceOn) speak('Voice enabled. Use fetch or simulate to load data.');
});
function speak(txt){ if(voiceOn && window.speechSynthesis){ const u = new SpeechSynthesisUtterance(txt); u.rate = 1; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);} }

// clear data
el('clearData').addEventListener('click', ()=> { priceData=[]; renderChartForPriceData(); el('stockMeta').textContent=''; el('cryptoMeta').textContent=''; });

// initial demo
priceData = simulatePrices('DEMO', 120, 100 + Math.random()*20);
renderChartForPriceData();
el('stockMeta').textContent = 'Demo simulated data loaded.';

</script>
</body>
</html>
